{% extends "base.html" %} {% block title %}Take Attendance - AI Attendance
System{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="text-primary">
      <i class="fas fa-camera me-2"></i>Take Attendance
    </h2>
    <p class="text-muted">
      Use your camera to automatically mark student attendance using face
      recognition.
    </p>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-video me-2"></i>Camera Feed</h5>
      </div>
      <div class="card-body text-center">
        <div id="camera-container" class="mb-3">
          <video id="video" width="640" height="480" autoplay muted></video>
          <canvas
            id="canvas"
            width="640"
            height="480"
            style="display: none"
          ></canvas>
        </div>

        <div class="mb-3">
          <button id="start-camera" class="btn btn-primary btn-lg me-2">
            <i class="fas fa-play me-2"></i>Start Camera
          </button>
          <button
            id="stop-camera"
            class="btn btn-danger btn-lg me-2"
            style="display: none"
          >
            <i class="fas fa-stop me-2"></i>Stop Camera
          </button>
          <button
            id="capture-attendance"
            class="btn btn-success btn-lg"
            style="display: none"
          >
            <i class="fas fa-camera me-2"></i>Capture Attendance
          </button>
        </div>

        <div id="status" class="alert alert-info" style="display: none">
          <i class="fas fa-info-circle me-2"></i>Camera is ready. Position
          students in front of the camera.
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-list-check me-2"></i>Attendance Status
        </h5>
      </div>
      <div class="card-body">
        <div id="attendance-list">
          <p class="text-muted text-center">
            Start the camera to begin taking attendance
          </p>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-users me-2"></i>Registered Students
        </h5>
      </div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          {% for student in students %}
          <div
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <div>
              <h6 class="mb-1">{{ student.name }}</h6>
              <small class="text-muted"
                >{{ student.roll_number }} • {{ student.class_name }}</small
              >
            </div>
            <span class="badge bg-secondary rounded-pill">Not Marked</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Attendance Results Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-check-circle me-2"></i>Attendance Results
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="attendance-results">
          <!-- Results will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveAttendance()"
        >
          Save to Database
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let stream = null;
  let video = document.getElementById('video');
  let canvas = document.getElementById('canvas');
  let startButton = document.getElementById('start-camera');
  let stopButton = document.getElementById('stop-camera');
  let captureButton = document.getElementById('capture-attendance');
  let statusDiv = document.getElementById('status');
  let attendanceList = document.getElementById('attendance-list');

  let detectedStudents = [];

  // Start camera
  startButton.addEventListener('click', async () => {
      try {
          stream = await navigator.mediaDevices.getUserMedia({
              video: {
                  width: 640,
                  height: 480,
                  facingMode: 'user'
              }
          });
          video.srcObject = stream;

          startButton.style.display = 'none';
          stopButton.style.display = 'inline-block';
          captureButton.style.display = 'inline-block';
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Camera is active. Position students in front of the camera.';
          statusDiv.className = 'alert alert-success';

      } catch (err) {
          console.error('Error accessing camera:', err);
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error accessing camera. Please check permissions.';
          statusDiv.className = 'alert alert-danger';
      }
  });

  // Stop camera
  stopButton.addEventListener('click', () => {
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
      }

      startButton.style.display = 'inline-block';
      stopButton.style.display = 'none';
      captureButton.style.display = 'none';
      statusDiv.style.display = 'none';

      // Clear video
      video.srcObject = null;
  });

  // Capture attendance
  let captureInFlight = false;

  captureButton.addEventListener('click', async () => {
      if (!stream) {
          alert('Please start the camera first');
          return;
      }

      if (captureInFlight) return;
      captureInFlight = true;
      const originalText = captureButton.innerHTML;
      captureButton.disabled = true;
      captureButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Recognizing...';

      // Draw current frame to canvas
      const ctx = canvas.getContext('2d');
      // Downscale frame before sending to reduce bandwidth and CPU
      const vw = video.videoWidth || 640;
      const vh = video.videoHeight || 480;
      const targetW = 320; // client resize for faster server processing
      const scale = targetW / vw;
      canvas.width = Math.round(vw * scale);
      canvas.height = Math.round(vh * scale);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

      // Send frame to backend for recognition
      try {
          const resp = await fetch('/api/recognize', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: dataUrl })
          });

          if (!resp.ok) {
              const text = await resp.text();
              alert('Recognition request failed: ' + text);
              return;
          }

          let result;
          const ct = resp.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
              result = await resp.json();
          } else {
              const text = await resp.text();
              alert('Unexpected response from server: ' + text);
              return;
          }

          if (!result.success) {
              alert('Recognition error: ' + (result.error || 'Unknown error'));
              return;
          }

          // Map detections to student objects known to the page
          const students = {{ students|tojson }};
          const byName = Object.fromEntries(students.map(s => [s.name, s]));
          const matched = [];
          result.detections.forEach(d => {
              if (d.name && d.name !== 'Unknown' && byName[d.name]) {
                  matched.push(byName[d.name]);
              }
          });

          detectedStudents = matched;
          showAttendanceResults(matched);
      } catch (e) {
          console.error(e);
          alert('Failed to contact recognition API');
      } finally {
          captureInFlight = false;
          captureButton.disabled = false;
          captureButton.innerHTML = originalText;
      }
  });

  function showAttendanceResults(students) {
      const resultsDiv = document.getElementById('attendance-results');
      let html = '<div class="alert alert-success mb-3"><i class="fas fa-check-circle me-2"></i>Face recognition completed!</div>';

      if (students.length > 0) {
          html += '<h6>Detected Students:</h6><ul class="list-group">';
          students.forEach(student => {
              html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                      <strong>${student.name}</strong><br>
                      <small class="text-muted">${student.roll_number} • ${student.class_name}</small>
                  </div>
                  <span class="badge bg-success rounded-pill">Detected</span>
              </li>`;
          });
          html += '</ul>';
      } else {
          html += '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No students detected. Please ensure students are properly positioned in front of the camera.</div>';
      }

      resultsDiv.innerHTML = html;

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
      modal.show();
  }

  function saveAttendance() {
      if (detectedStudents.length === 0) {
          alert('No students detected to save');
          return;
      }

      // Send to backend
      fetch('/api/process_attendance', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              detected_students: detectedStudents
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              alert(`Attendance saved successfully! ${data.marked_count} students marked present.`);
              location.reload(); // Refresh to show updated attendance
          } else {
              alert('Error saving attendance: ' + data.error);
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Error saving attendance. Please try again.');
      });
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
      }
  });
</script>
{% endblock %}
